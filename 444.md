# Service Onboarding and API Registration

{% admonition type="info"%}
The service onboarding steps (Steps 1-4) are only required when setting up your service for the first time. If you're adding a new API version to an existing service, skip to [Registering and updating an OpenAPI definition](#registering-and-updating-an-openapi-definition).
{% /admonition %}

## Step 1: Creating a service directory and defining code owners

A service directory in GitHub ([organization: glcp](https://github.com/glcp), [repository: intg-doc-portal](https://github.com/glcp/intg-doc-portal)) hosts the documentation of your OpenAPI definition. Redocly Reunite serves the documentation files in the service directory to the HPE GreenLake Developer Portal. Code owners define teams that are responsible for code in a GitHub repository and for review of pull request that modifies code that they own.

{% admonition type="info"%}
When the code owner is a team, that team must have write permissions for the GitHub repository. To request write access for your team, see [Joining the HPE GitHub organization GLCP and creating a GitHub team](/docs/greenlake/guides/internal/dev_portal_api_onboarding/prerequisites/#joining-the-hpe-github-organization-glcp-and-creating-a-github-team) in this guide.

{% /admonition %}

To create the service directory and define code owners for your service, you will need the following information:

* Your **team name** in the GitHub organization _glcp_. If you don't know your team name, check the [list of glcp teams](https://github.com/orgs/glcp/teams) in GitHub. If you do not find your team in that list, contact [glcp.help-apicli@hpe.com](mailto:glcp.help-apicli@hpe.com) for guidance.
* The **service name**. This service name is used to create the service directory in the GitHub _intg-doc-portal_ repository. Example location: [GreenLake services](https://github.com/glcp/doc-portal/tree/master/docs/greenlake/services). Example service directory name: sample-service. Follow the previous GitHub URL for examples of production service directory names.

1. Create a directory for your service in GitHub glcp organization, under the intg-doc-portal repository based on your service name.

2. Add your GitHub organization glcp team name and service name to the [CODEOWNERS file](https://github.com/glcp/doc-portal/blob/master/CODEOWNERS) under the appropriate section:

* **Services** for a new HPE GreenLake cloud service.
* **HPE GreenLake Central** for a new HPE GreenLake Flex Solution.

As service owner of your OpenAPI definition project with **_write_** access to the intg-doc-portal repository, submit a GitHub pull request (PR), in a **branch**, to create the directory for your service, and add the team name to the CODEOWNERS file for a new HPE GreenLake cloud service similar to the [sample-service](https://github.com/glcp/doc-portal/blob/f89389ae3d1f6a61656f5fbe611eefc94cc51295/CODEOWNERS#L47) or the [billing service](https://github.com/glcp/doc-portal/blob/f89389ae3d1f6a61656f5fbe611eefc94cc51295/CODEOWNERS#L51). The API CLI team will review and approve the changes through the PR. Refer to the [About code owners](https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners) and [Creating a pull request](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) GitHub documentation for further information.

## Step 2: Cloning your service directory and creating a branch

To organize your service directory and integrate your service API reference documentation into the HPE GreenLake Developer Portal:

1. Make a clone of the _intg-doc-portal_ [repository](https://github.com/glcp/intg-doc-portal) on your local computer. A tool such as Visual Studio Code is recommended to make the clone of the intg-doc-portal repository.
2. Create a branch and check out into the branch to ensure that the default (master) branch only contains finished and approved work.
3. In your working branch, organize your service directory by applying the changes described in the following steps.
4. Once you finish and are satisfied with your changes in your branch, commit your changes and open a pull request for review and approval before publication of your service API reference documentation in the HPE GreenLake Developer Portal.

## Step 3: Organizing your service directory

After you created your service directory in GitHub (step 1), cloned the intg-doc-portal repository on your local computer and you've created a branch (step 2) for the changes in this and later steps, you must now create certain directories and files to organize your service directory in your working branch.

1. Create a directory with your service name following the below structure:

    ```text
    hpesample-dev/
    ├── internal/
    │   ├── openapi/
    │   │   ├── changelog.md
    │   │   └── hpesample-dev-latest/
    │   │       └── openapi.yaml
    │   └── index.md
    ├── partner/
    │   ├── openapi/
    │   │   ├── changelog.md
    │   │   └── hpesample-dev-latest/
    │   │       └── openapi.yaml
    │   ├── guide.md
    │   └── index.md
    ├── public/
    │   ├── openapi/
    │   │   ├── changelog.md
    │   │   ├── hpesample-dev-v1/
    │   │   │   └── openapi.yaml
    │   │   └── hpesample-dev-v2/
    │   │       └── openapi.yaml
    │   ├── guide.md
    │   └── index.md
    └── sidebars.yaml
    ```

    {% admonition type="info"%}
    Add openapi.yaml file inside your created service directory only if you are manually adding the OpenAPI definition following [Registering a new OpenAPI definition manually](#option-2-registering-a-new-openapi-definition-manually).

    {% /admonition %}

2. Omit any directories not applicable. For example, if your OpenAPI definition is not meant for a partner do not include that directory. See the table below for a description of each directory type and the associated permissions in the redocly.yaml file.
3. Add needed subdirectories, for example, images, within internal, partner, or public, or the main service directory.

| **Directory name** | **API documentation visibility** | **Required RBAC role** |
| --- | --- | --- |
| internal | Visible to HPE personnel only | hpe-dev-portal-internal |
| partner | Visible for partners only | hpe-dev-portal-greenlake-partner |
| public | Visible to anyone | (For unrestricted access, need not specify the role.) |

{% admonition type="info"%}
Check [Registering a new OpenAPI definition](#registering-a-new-openapi-definition) for available options to add your service OpenAPI definition. Continue to [Step 4](#step-4-committing-and-submitting-your-changes-as-a-pull-request) if you are adding API definition using remote content. Skip to [Registering a new OpenAPI definition manually](#option-2-registering-a-new-openapi-definition-manually) if you are adding API definition by creating file in the portal repo.

{% /admonition %}

## Step 4: Committing and submitting your changes as a pull request

1. Save all the files you've edited in the working branch of your service directory.
2. Commit and submit the changes as a pull request.
3. Start the [review process of your API](https://hpe.atlassian.net/wiki/spaces/AR/pages/2290123101/NB+API+Review+process) by emailing [glcp.help-apicli@hpe.com](mailto:glcp.help-apicli@hpe.com) to notify them that your PR is ready for review, approval, and eventual merging and publication of your API reference documentation to the HPE GreenLake Developer Portal (You can expect a response in about 24 hours). You can also inform the [#glcp-doc-portal](https://hpe-internal.slack.com/archives/C0351KTDJ6A) Slack channel.

## Registering and updating an OpenAPI definition

To publish documentation for your APIs to the HPE GreenLake Developer Portal, you must first register the OpenAPI definition in the Redocly Reunite portal. Reunite is Redocly's cloud platform for creating, editing, previewing, and deploying API documentation projects using a Git-based version control system.

This section covers how to register or update an OpenAPI definition, register a new API version in the API onboarding process. After registering an OpenAPI definition, proceed with the steps to [Integrating an OpenAPI definition in the HPE GreenLake Developer Portal and writing concepts](/docs/greenlake/guides/internal/dev_portal_api_onboarding/integrate_api_definition/#integrating-an-openapi-definition-in-the-hpe-greenlake-developer-portal-and-writing-concepts).

{% admonition type="info" name="**IMPORTANT NOTE**" %}

* As a best practice - whenever you introduce a **major version** of your API (e.g., v1beta1, v1, v2), create a **separate OpenAPI definition file** for each major version.
* If the OpenAPI definition file for your service already exists, delete the file before adding a new one to avoid duplicates and keep the codebase clean.

{% /admonition %}

## Registering a new OpenAPI definition

There are 2 ways you could register a new OpenAPI definition as described below. Preferably follow [Registering a new OpenAPI definition through remote content](#option-1-registering-a-new-openapi-definition-through-remote-content-recommended) to connect OpenAPI definition from the service.

### Option 1: Registering a new OpenAPI definition through remote content (Recommended)

Remote content is a feature that copies content from other file sources into your Redocly project. Remote content enables single-source content management by allowing you to maintain content in its original location while automatically syncing it to your documentation.

1. Ensure that you have Redocly Member access and log in with SSO to the [Redocly portal](https://app.cloud.redocly.com/org/hpe).
2. Choose the project - **stage-developer-portal-hpe**.
3. Click on the GitHub branch at the top and create a new branch for adding OpenAPI definition. Refer to the Redocly [Create a new branch](https://redocly.com/docs/realm/setup/how-to/remote-content/from-github#create-a-new-branch-in-reunite) documentation for details.
![Screenshot of branch creation in reunite](./images/create_branch.png)
4. Navigate to your service folder from the left pane and click **+ Add content** in the editor.
![Screenshot of add content in reunite](./images/add_content_remote.png)
5. Choose **New remote folder** and click on **Add Git repository**.
6. Enter a name for the OpenAPI definition remote folder. Preferably provide the service name with the API version (ex: sample-service-v1).
7. Select the provider as **GitHub** and click next.
8. Select your GitHub organization (for example glcp). If your organization is not listed, see [If your GitHub organization is not shown in Reunite](#if-your-github-organization-is-not-shown-in-reunite).
9. Select the folder for the OpenAPI definition and click on Add Remote. If there are multiple OpenAPI versions in different folders, create a remote folder for each of the API version by following the above steps.
![Screenshot of connecting remote github folder in reunite](./images/remote_content_github.png)

Refer [Add remote files from GitHub](https://redocly.com/docs/realm/setup/how-to/remote-content/from-github#add-remote-files-from-github) for more details.

{% admonition type="info" name="**IMPORTANT NOTE**" %}

* Make sure to create the remote folder inside your service directory under the appropriate folder path. Ex: For an OpenAPI definition intended for internal users, create the remote folder inside _<service-folder>/internal/openapi_.
* Keep the toggle on for Auto-sync and Auto-merge. This enables update to any OpenAPI definition in the service repository to reflect in the Developer Portal automatically.

{% /admonition %}

Once the remote content is added, a PR will be automatically raised in the developer portal repo to add the OpenAPI definition files. This has to be merged manually after all the PR checks pass and required approvals are received. Any subsequent change to the OpenAPI specification in the service repository gets reflected automatically in the developer portal.  

### Option 2: Registering a new OpenAPI definition manually

As an alternative, you could even manually add the OpenAPI definition file in the developer portal github repo under your service directory. With this, you would need to manually update the file content whenever there is a change in the OpenAPI specification. Follow the below steps for manually adding OpenAPI definition.

1. Clone the [intg-doc-portal](https://github.com/glcp/intg-doc-portal) repository on your local computer.
2. Create a branch and check out into the branch.
3. Create the yaml file under appropriate directory and add the OpenAPI definition. Preferably use the service name with the API version as the filename. For example, create sample-service-v1.yaml file under _sample-service/internal/openapi/sample-service._
4. Save all the files you've edited in the working branch of your service directory.
5. Commit and submit the changes as a pull request.

{% admonition type="info" name="**IMPORTANT NOTE**" %}
Make sure to create the file inside your service directory under the appropriate folder path. Ex: For an OpenAPI definition intended for internal users, create the OpenAPI definition file inside _<service-folder>/internal/openapi_.
{% /admonition %}

After registering an OpenAPI definition, proceed with the steps to [Integrating an OpenAPI definition in the HPE GreenLake Developer Portal and writing concepts](/docs/greenlake/guides/internal/dev_portal_api_onboarding/integrate_api_definition#integrating-an-openapi-definition-in-the-hpe-greenlake-developer-portal-and-writing-concepts).

### _If your GitHub organization is not shown in Reunite_

If your organization (for example glcp) is not available under "GitHub organizations", you need to force Redocly to reconnect to your GitHub profile after you have been added to a new organization. Perform the following steps on GitHub and Redocly to fix this issue:

On GitHub

1. In your HPE GitHub Profile choose Settings.
2. From Integrations choose Applications.
3. Click the **Authorized GitHub Apps** tab.
4. Revoke the Redocly access.

On Redocly

1. Ensure that you have Redocly Member access and log in with SSO to the [Redocly Reunite portal](https://app.cloud.redocly.com/org/hpe).
2. Navigate to your service folder and click **+ Add content** in the editor.
3. Choose **New remote folder** and click on **Add Git repository**.
4. If the GitHub Organization is not shown, click on **Install the Redocly GitHub App**.
5. When prompted, again authorize Redocly to your HPE GitHub profile.

You will now see all your current organizations.

Refer Redocly documentation for details [Installing Redocly app on GitHub](https://redocly.com/docs/realm/setup/how-to/remote-content/from-github#install-the-redocly-app-in-github)

## Updating an existing OpenAPI definition

If the source of your OpenAPI definition is a GitHub repo and you want the API definition from a different branch (not the one linked already) to reflect in the developer portal, follow the below steps:

API definition linked through remote content:

1. Ensure that you have Redocly Member access and log in with SSO to the [Redocly portal](https://app.cloud.redocly.com/org/hpe).
2. Choose the project - **stage-developer-portal-hpe**.
3. Navigate to Remote content from the left pane and delete the specific OpenAPI definition version you want to update.
![Screenshot of remote content deletion](./images/remote_content_delete.png)
4. In the editor, delete the remote folder for the API version you want to update.
![Screenshot of remote folder deletion](./images/remote_folder_delete.png)
5. Create a new remote folder with the appropriate branch. Follow the steps from [Add OpenAPI definition remote folder](#option-1-registering-a-new-openapi-definition-through-remote-content-recommended).

API definition added manually:

1. Clone the [intg-doc-portal](https://github.com/glcp/intg-doc-portal) repository on your local computer.
2. Create a branch and check out into the branch.
3. Navigate to your service folder and modify the specific API definition file with updated content.
4. Commit and submit the changes as a pull request.

## Registering a new version of an existing OpenAPI definition

Follow this procedure to register a new version of an OpenAPI definition to prepare it for publication to the HPE GreenLake Developer Portal. If multiple versions have been published, a user reading the API documentation in the HPE GreenLake Developer Portal can choose the version of the documentation to view from a drop-down list.

Follow the steps from [Registering a new OpenAPI definition](#registering-a-new-openapi-definition) for adding a new version of OpenAPI specification. Refer to both approaches available (remote content and manual addition) and choose whichever is appropriate.

After registering a new API definition version, proceed with the steps to [Integrating an OpenAPI definition in the HPE GreenLake Developer Portal and writing concepts](/docs/greenlake/guides/internal/dev_portal_api_onboarding/integrate_api_definition#integrating-an-openapi-definition-in-the-hpe-greenlake-developer-portal-and-writing-concepts).
